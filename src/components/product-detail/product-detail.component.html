

@if (productWithDisplayPrice(); as p) {
  <div class="bg-white dark:bg-gray-900">
    <div class="lg:grid lg:grid-cols-12 lg:gap-8 lg:p-4">
      
      <!-- IMAGE GALLERY - Spans 7 cols on desktop -->
      <div class="lg:col-span-7">
        <!-- Mobile Gallery -->
        <div class="lg:hidden">
          <!-- Main Image Display -->
          <div class="relative aspect-square bg-gray-100 dark:bg-gray-800">
            @for(image of p.images; track image; let i = $index) {
              <div class="absolute inset-0 transition-opacity duration-300 ease-in-out"
                  [class.opacity-100]="activeImageIndex() === i"
                  [class.opacity-0]="activeImageIndex() !== i">
                @if (i === 0) {
                  <img [ngSrc]="image" [alt]="p.name + ' by ' + p.brand + ' - view ' + (i+1)" fill priority class="w-full h-full object-contain">
                } @else {
                  <img [ngSrc]="image" [alt]="p.name + ' by ' + p.brand + ' - view ' + (i+1)" fill class="w-full h-full object-contain">
                }
              </div>
            }
            <!-- Wishlist Button -->
            <button (click)="stateService.toggleWishlist(p.id)" class="absolute top-2 right-2 z-10 bg-gray-900/30 dark:bg-black/30 backdrop-blur-sm rounded-full p-2.5 text-white hover:text-pink-400 transition-colors">
                @if(stateService.wishlist().has(p.id)) {
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-pink-500" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                    </svg>
                } @else {
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                    </svg>
                }
            </button>
          </div>

          <!-- Thumbnails -->
          @if (p.images.length > 1) {
            <div class="p-2">
              <div class="flex overflow-x-auto space-x-2 pb-2">
                @for(image of p.images; track image; let i = $index) {
                  <div class="flex-shrink-0">
                    <img (click)="goToSlide(i)" [ngSrc]="image" [alt]="'Thumbnail ' + (i+1)"
                        width="64" height="80"
                        class="w-16 h-20 object-cover rounded-md cursor-pointer border-2 transition-all"
                        [class.border-pink-500]="i === activeImageIndex()"
                        [class.border-transparent]="i !== activeImageIndex()">
                  </div>
                }
              </div>
            </div>
          }
        </div>

        <!-- Desktop Gallery -->
        <div class="hidden lg:flex lg:space-x-4">
          <!-- Vertical Thumbnails -->
          <div class="w-20 flex-shrink-0 space-y-2">
            @for(image of p.images; track image; let i = $index) {
              <img (click)="goToSlide(i)" [ngSrc]="image" [alt]="p.name + ' thumbnail ' + (i+1)" width="80" height="112" class="w-full h-28 object-cover rounded-lg cursor-pointer border-2 transition-all" [class.border-pink-500]="i === activeImageIndex()" [class.border-transparent]="i !== activeImageIndex()" [class.opacity-50]="i !== activeImageIndex()" [class.hover:opacity-100]="i !== activeImageIndex()">
            }
          </div>
          <!-- Main Image -->
          <div class="flex-grow relative h-[36rem] overflow-hidden rounded-lg bg-gray-100 dark:bg-gray-800">
            @for(image of p.images; track image; let i = $index) {
              <div class="absolute inset-0 transition-opacity duration-300 ease-in-out"
                  [class.opacity-100]="activeImageIndex() === i"
                  [class.opacity-0]="activeImageIndex() !== i">
                @if (i === 0) {
                  <img [ngSrc]="image" [alt]="p.name + ' by ' + p.brand + ' - view ' + (i+1)" fill priority class="w-full h-full object-contain">
                } @else {
                  <img [ngSrc]="image" [alt]="p.name + ' by ' + p.brand + ' - view ' + (i+1)" fill class="w-full h-full object-contain">
                }
              </div>
            }
          </div>
        </div>
      </div>

      <!-- PRODUCT INFO - Spans 5 cols on desktop -->
      <div class="p-4 lg:p-0 lg:col-span-5 text-gray-800 dark:text-gray-200">
        <div class="flex justify-between items-start">
          <div class="overflow-hidden">
            <h1 class="text-2xl font-bold break-words">{{ p.brand }}</h1>
            <p class="text-gray-500 dark:text-gray-400 text-lg break-words">{{ p.name }}</p>
          </div>
          <div class="border rounded-md px-2 py-1 text-sm font-semibold flex items-center shrink-0 border-gray-200 dark:border-gray-700 ml-2">
            {{ p.rating }} ★ | {{ formatReviews(p.reviews) }}
          </div>
        </div>
        
        @if(isFlashSaleActive()) {
          <div class="mt-4 p-3 rounded-lg bg-red-100 dark:bg-red-900/50 border border-red-200 dark:border-red-700">
              <div class="flex items-center text-red-700 dark:text-red-400">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 animate-pulse" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                  <h3 class="font-bold text-lg">Flash Sale!</h3>
              </div>
              <div class="flex items-baseline space-x-2 mt-2">
                  <p class="text-2xl font-bold text-red-700 dark:text-red-400">₹{{ p.flashSale.price }}</p>
                  <p class="text-md text-gray-500 dark:text-gray-400 line-through">MRP ₹{{ p.originalPrice }}</p>
              </div>
              <div class="mt-2 text-center bg-red-200 text-red-800 dark:bg-red-800/50 dark:text-red-300 font-mono text-sm font-bold py-1 px-2 rounded">
                Ends in: {{ flashSaleTimeRemaining() }}
              </div>
          </div>
        } @else {
          <div class="flex items-baseline space-x-2 mt-2">
            <p class="text-2xl font-bold">₹{{ p.displayPrice }}</p>
            @if(p.displayPrice !== p.originalPrice) {
              <p class="text-md text-gray-500 dark:text-gray-400 line-through">MRP ₹{{ p.originalPrice }}</p>
            }
            @if(p.discount > 0 && !p.b2bPrice) {
              <p class="text-md text-orange-500 dark:text-orange-400 font-bold">({{ p.discount }}% OFF)</p>
            }
            @if(stateService.isB2B() && p.b2bPrice) {
              <span class="text-xs font-bold text-white bg-blue-500 px-2 py-0.5 rounded">B2B Price</span>
            }
          </div>
        }
        <p class="text-xs text-teal-600 dark:text-teal-500 font-semibold mt-1">inclusive of all taxes</p>

        <!-- Size Selection -->
        <div class="mt-6">
          <div class="flex justify-between items-center">
            <h3 class="font-bold text-lg">Select Size</h3>
            <a href="#" class="text-sm font-semibold text-pink-500 dark:text-pink-400">Size Chart ></a>
          </div>
          <div class="flex flex-wrap gap-2 mt-2">
            @for(size of p.sizes; track size.name) {
              <button (click)="selectSize(size.name)" 
                      [disabled]="!size.inStock"
                      class="h-12 w-12 border rounded-full font-bold flex items-center justify-center transition-colors relative border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700" 
                      [class.bg-pink-500]="selectedSize() === size.name" 
                      [class.text-white]="selectedSize() === size.name"
                      [class.border-pink-500]="selectedSize() === size.name"
                      [class.bg-gray-100]="!size.inStock"
                      [class.text-gray-400]="!size.inStock"
                      [class.dark:bg-gray-800]="!size.inStock"
                      [class.dark:text-gray-600]="!size.inStock"
                      [class.cursor-not-allowed]="!size.inStock">
                {{ size.name }}
                @if(!size.inStock) {
                  <span class="absolute top-1/2 left-0 w-full h-0.5 bg-gray-400 dark:bg-gray-600 transform -rotate-45"></span>
                }
              </button>
            }
          </div>
        </div>
        
        <!-- Custom Photo Upload -->
        @if (p.allowPhotoUpload) {
          <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
            <h3 class="font-bold text-lg mb-2">✨ Add a Personal Touch (Optional)</h3>
            @if(customization(); as cust) {
              <div class="flex items-center space-x-4">
                <img [src]="cust.previewUrl" alt="Custom photo preview" class="w-20 h-20 object-cover rounded-md border border-gray-200 dark:border-gray-600">
                <div class="flex-grow">
                  <p class="text-sm font-semibold text-gray-700 dark:text-gray-300">{{ cust.file.name }}</p>
                  <p class="text-xs text-gray-500">{{ (cust.file.size / 1024).toFixed(1) }} KB</p>
                </div>
                <button (click)="removePhoto()" class="text-sm font-semibold text-red-500 dark:text-red-400 hover:underline">Remove</button>
              </div>
            } @else {
              <label class="w-full text-center py-3 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-md font-bold flex items-center justify-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-400">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                  Upload Your Photo
                  <input type="file" (change)="handlePhotoUpload($event)" class="hidden" accept="image/png, image/jpeg">
              </label>
            }
          </div>
        }
        
        <!-- Action Buttons (Mobile & Desktop) -->
        <div class="flex items-center space-x-2 mt-6">
           <button (click)="addToBag()" class="w-full py-3 border border-gray-300 dark:border-gray-700 rounded-md font-bold flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg>
            ADD TO BAG
          </button>
          <button (click)="buyNow()" class="w-full py-3 bg-pink-500 text-white rounded-md font-bold flex items-center justify-center hover:bg-pink-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
            BUY NOW
          </button>
        </div>

        <!-- COD Availability -->
        <div class="mt-4 text-sm font-semibold flex items-center" [class.text-green-600]="p.isCodAvailable" [class.dark:text-green-500]="p.isCodAvailable" [class.text-red-600]="!p.isCodAvailable" [class.dark:text-red-500]="!p.isCodAvailable">
          @if(p.isCodAvailable) {
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
            <span>Cash on Delivery Available</span>
          } @else {
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
            <span>Cash on Delivery Not Available</span>
          }
        </div>

        <!-- Product Details (Desktop) -->
        <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700 hidden lg:block">
          <h3 class="font-bold text-lg mb-2">Product Details</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">{{ p.details[0] }}</p>
          
          <div class="grid grid-cols-2 text-sm gap-y-3 gap-x-4 mb-4">
              <div>
                  <p class="font-semibold text-gray-500 dark:text-gray-400">SKU</p>
                  <p class="text-gray-800 dark:text-gray-200">{{ p.id }}</p>
              </div>
              @if(p.color) {
                <div>
                    <p class="font-semibold text-gray-500 dark:text-gray-400">Color</p>
                    <p class="text-gray-800 dark:text-gray-200">{{ p.color }}</p>
                </div>
              }
              @if(p.idealFor) {
                <div>
                    <p class="font-semibold text-gray-500 dark:text-gray-400">Ideal For</p>
                    <p class="text-gray-800 dark:text-gray-200">{{ p.idealFor }}</p>
                </div>
              }
              @if(p.pattern) {
                <div>
                    <p class="font-semibold text-gray-500 dark:text-gray-400">Pattern</p>
                    <p class="text-gray-800 dark:text-gray-200">{{ p.pattern }}</p>
                </div>
              }
              @if(p.fabric) {
                <div>
                    <p class="font-semibold text-gray-500 dark:text-gray-400">Fabric</p>
                    <p class="text-gray-800 dark:text-gray-200">{{ p.fabric }}</p>
                </div>
              }
              @if(p.sleeve) {
                <div>
                    <p class="font-semibold text-gray-500 dark:text-gray-400">Sleeve</p>
                    <p class="text-gray-800 dark:text-gray-200">{{ p.sleeve }}</p>
                </div>
              }
              @if(p.closure) {
                <div>
                    <p class="font-semibold text-gray-500 dark:text-gray-400">Closure</p>
                    <p class="text-gray-800 dark:text-gray-200">{{ p.closure }}</p>
                </div>
              }
              @if(p.fabricCare) {
                <div>
                    <p class="font-semibold text-gray-500 dark:text-gray-400">Fabric Care</p>
                    <p class="text-gray-800 dark:text-gray-200">{{ p.fabricCare }}</p>
                </div>
              }
              @if(p.fit) {
                <div>
                    <p class="font-semibold text-gray-500 dark:text-gray-400">Fit</p>
                    <p class="text-gray-800 dark:text-gray-200">{{ p.fit }}</p>
                </div>
              }
          </div>

          <ul class="list-disc list-inside text-sm text-gray-600 dark:text-gray-400 space-y-1 mb-4">
            @for(detail of productDetailsBody(); track detail) {
              <li>{{ detail }}</li>
            }
          </ul>
        </div>
      </div>
    </div>

    <!-- ACCORDION FOR MOBILE -->
    <div class="lg:hidden mt-6">
        <!-- Product Details -->
        <div class="border-y border-gray-200 dark:border-gray-700">
            <button (click)="toggleAccordion('details')" class="w-full flex justify-between items-center p-4">
                <h3 class="font-semibold text-gray-800 dark:text-gray-200">Product Details</h3>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform duration-300 text-gray-800 dark:text-gray-200" [class.rotate-180]="openAccordion() === 'details'" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
            </button>
            @if(openAccordion() === 'details') {
                <div class="p-4 pt-0 text-gray-600 dark:text-gray-400">
                    <p class="text-sm mb-4">{{ p.details[0] }}</p>
                    <div class="grid grid-cols-2 text-sm gap-y-3 gap-x-4 mb-4">
                        <div>
                            <p class="font-semibold text-gray-500 dark:text-gray-400">SKU</p>
                            <p class="text-gray-800 dark:text-gray-200">{{ p.id }}</p>
                        </div>
                        @if(p.color) {
                          <div>
                              <p class="font-semibold text-gray-500 dark:text-gray-400">Color</p>
                              <p class="text-gray-800 dark:text-gray-200">{{ p.color }}</p>
                          </div>
                        }
                        @if(p.idealFor) {
                          <div>
                              <p class="font-semibold text-gray-500 dark:text-gray-400">Ideal For</p>
                              <p class="text-gray-800 dark:text-gray-200">{{ p.idealFor }}</p>
                          </div>
                        }
                        @if(p.pattern) {
                          <div>
                              <p class="font-semibold text-gray-500 dark:text-gray-400">Pattern</p>
                              <p class="text-gray-800 dark:text-gray-200">{{ p.pattern }}</p>
                          </div>
                        }
                        @if(p.fabric) {
                          <div>
                              <p class="font-semibold text-gray-500 dark:text-gray-400">Fabric</p>
                              <p class="text-gray-800 dark:text-gray-200">{{ p.fabric }}</p>
                          </div>
                        }
                        @if(p.sleeve) {
                          <div>
                              <p class="font-semibold text-gray-500 dark:text-gray-400">Sleeve</p>
                              <p class="text-gray-800 dark:text-gray-200">{{ p.sleeve }}</p>
                          </div>
                        }
                        @if(p.closure) {
                          <div>
                              <p class="font-semibold text-gray-500 dark:text-gray-400">Closure</p>
                              <p class="text-gray-800 dark:text-gray-200">{{ p.closure }}</p>
                          </div>
                        }
                        @if(p.fabricCare) {
                          <div>
                              <p class="font-semibold text-gray-500 dark:text-gray-400">Fabric Care</p>
                              <p class="text-gray-800 dark:text-gray-200">{{ p.fabricCare }}</p>
                          </div>
                        }
                        @if(p.fit) {
                          <div>
                              <p class="font-semibold text-gray-500 dark:text-gray-400">Fit</p>
                              <p class="text-gray-800 dark:text-gray-200">{{ p.fit }}</p>
                          </div>
                        }
                    </div>
                    <ul class="list-disc list-inside text-sm space-y-1 mb-4">
                        @for(detail of productDetailsBody(); track detail) {
                        <li>{{ detail }}</li>
                        }
                    </ul>
                </div>
            }
        </div>

        <!-- Product Video -->
        @if(safeVideoUrl(); as url) {
            <div class="border-b border-gray-200 dark:border-gray-700">
                <button (click)="toggleAccordion('video')" class="w-full flex justify-between items-center p-4">
                    <h3 class="font-semibold text-gray-800 dark:text-gray-200">Product Video</h3>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform duration-300 text-gray-800 dark:text-gray-200" [class.rotate-180]="openAccordion() === 'video'" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </button>
                @if(openAccordion() === 'video') {
                    <div class="p-4 pt-0">
                        <div class="aspect-video">
                            <iframe [src]="url" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="w-full h-full rounded-lg shadow-lg"></iframe>
                        </div>
                    </div>
                }
            </div>
        }

        <!-- Ratings & Reviews -->
        <div class="border-b border-gray-200 dark:border-gray-700">
            <button (click)="toggleAccordion('reviews')" class="w-full flex justify-between items-center p-4">
                <h3 class="font-semibold text-gray-800 dark:text-gray-200">Ratings & Reviews</h3>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform duration-300 text-gray-800 dark:text-gray-200" [class.rotate-180]="openAccordion() === 'reviews'" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
            </button>
            @if(openAccordion() === 'reviews') {
                <div class="p-4 pt-0">
                    <!-- User Submitted Reviews -->
                    <div class="mt-6">
                        @for(review of productReviews(); track review.date) {
                        <div class="border-b border-gray-200 dark:border-gray-700 py-4">
                            <div class="flex items-center mb-1">
                            <span class="font-semibold text-gray-800 dark:text-gray-200">{{review.author}}</span>
                            <div class="flex items-center ml-4">
                                @for (star of [1,2,3,4,5]; track star) {
                                <svg class="w-4 h-4" [class.text-yellow-400]="star <= review.rating" [class.text-gray-300]="star > review.rating" [class.dark:text-gray-600]="star > review.rating" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                                }
                            </div>
                            </div>
                            <p class="text-gray-600 dark:text-gray-400 text-sm">{{review.comment}}</p>
                            <p class="text-xs text-gray-500 mt-1">{{review.date | date:'medium'}}</p>
                        </div>
                        }
                    </div>

                    <!-- Write a Review -->
                    <div class="mt-6">
                        <button (click)="showReviewForm.set(!showReviewForm())" class="font-bold text-pink-500 dark:text-pink-400">Write a Review</button>
                        @if (showReviewForm()) {
                        <form [formGroup]="reviewForm" (ngSubmit)="submitReview()" class="mt-4 p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800">
                            <div class="mb-2">
                            <label class="font-semibold text-gray-800 dark:text-gray-200">Your Rating</label>
                            <div class="flex items-center">
                                <input type="number" formControlName="rating" class="hidden">
                                @for (star of [1,2,3,4,5]; track star) {
                                    <svg (click)="reviewForm.controls.rating.setValue(star)" class="w-6 h-6 cursor-pointer" [class.text-yellow-400]="star <= reviewForm.value.rating!" [class.text-gray-300]="star > reviewForm.value.rating!" [class.dark:text-gray-600]="star > reviewForm.value.rating!" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                                }
                            </div>
                            </div>
                            <textarea formControlName="comment" placeholder="Write your review here..." rows="4" class="w-full p-2 border rounded-md bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200"></textarea>
                            <button type="submit" [disabled]="reviewForm.invalid" class="mt-2 px-4 py-2 bg-pink-500 text-white font-semibold rounded-lg disabled:bg-gray-500">Submit Review</button>
                        </form>
                        }
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Video Section (Desktop) -->
    @if(safeVideoUrl(); as url) {
      <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 p-4 hidden lg:block">
        <h3 class="font-bold text-lg mb-4">Product Video</h3>
        <div class="aspect-video">
          <iframe [src]="url" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="w-full h-full rounded-lg shadow-lg"></iframe>
        </div>
      </div>
    }

    <!-- Ratings & Reviews (Desktop) -->
    <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 p-4 hidden lg:block">
      <h3 class="font-bold text-lg mb-2">Ratings & Reviews</h3>
      <div class="mt-6">
        @for(review of productReviews(); track review.date) {
          <div class="border-b dark:border-gray-700 py-4">
            <div class="flex items-center mb-1">
              <span class="font-semibold">{{review.author}}</span>
              <div class="flex items-center ml-4">
                @for (star of [1,2,3,4,5]; track star) {
                  <svg class="w-4 h-4" [class.text-yellow-400]="star <= review.rating" [class.text-gray-300]="star > review.rating" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                }
              </div>
            </div>
            <p class="text-gray-600 dark:text-gray-400 text-sm">{{review.comment}}</p>
            <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">{{review.date | date:'medium'}}</p>
          </div>
        }
      </div>
      <div class="mt-6">
        <button (click)="showReviewForm.set(!showReviewForm())" class="font-bold text-pink-500">Write a Review</button>
        @if (showReviewForm()) {
          <form [formGroup]="reviewForm" (ngSubmit)="submitReview()" class="mt-4 p-4 border dark:border-gray-700 rounded-lg">
            <div class="mb-2">
              <label class="font-semibold">Your Rating</label>
              <div class="flex items-center">
                <input type="number" formControlName="rating" class="hidden">
                 @for (star of [1,2,3,4,5]; track star) {
                    <svg (click)="reviewForm.controls.rating.setValue(star)" class="w-6 h-6 cursor-pointer" [class.text-yellow-400]="star <= reviewForm.value.rating!" [class.text-gray-300]="star > reviewForm.value.rating!" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                 }
              </div>
            </div>
            <textarea formControlName="comment" placeholder="Write your review here..." rows="4" class="w-full p-2 border dark:border-gray-700 rounded-md bg-transparent"></textarea>
            <button type="submit" [disabled]="reviewForm.invalid" class="mt-2 px-4 py-2 bg-pink-500 text-white font-semibold rounded-lg disabled:bg-gray-300">Submit Review</button>
          </form>
        }
      </div>
    </div>

    <!-- Similar Products -->
    <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 p-4">
      <h3 class="font-bold text-lg mb-4 text-gray-800 dark:text-gray-200">SIMILAR PRODUCTS</h3>
      <div class="flex overflow-x-auto space-x-4">
        @for(sp of similarProducts(); track sp.id; let i = $index) {
          <div (click)="viewSimilarProduct(sp.id)" class="w-40 shrink-0 cursor-pointer bg-white dark:bg-gray-800 rounded-md p-2 border dark:border-gray-700">
            <img [ngSrc]="sp.images[0]" [alt]="sp.name" width="160" height="213" class="w-full aspect-[3/4] object-cover rounded-md" [priority]="i < 4">
            <h4 class="font-bold truncate mt-2 text-gray-800 dark:text-gray-100">{{ sp.brand }}</h4>
            <p class="text-sm text-gray-500 dark:text-gray-400 truncate">{{ sp.name }}</p>
            <p class="font-semibold text-gray-800 dark:text-gray-100">₹{{ sp.price }}</p>
          </div>
        }
      </div>
    </div>
  </div>

} @else {
  <div class="p-8 text-center text-gray-500">
    <p>Product not found.</p>
  </div>
}
